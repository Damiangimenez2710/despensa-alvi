<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Despensa Alvi</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff6600">

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js');
  });
}
</script>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f1f3f4}
header{display:flex;justify-content:space-between;align-items:center;padding:18px;background:white}
header button{padding:10px 16px;border-radius:20px;border:none;background:#1a73e8;color:white}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:white;border-radius:14px;padding:16px;margin-bottom:14px}
input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc}
button{cursor:pointer}
</style>
</head>

<body>

<header>
  <h2>Despensa Alvi</h2>
  <button onclick="showAdd()">Agregar</button>
  <button onclick="showList()">Lista</button>
</header>

<div class="container">

<div id="addView" style="display:none">

<div class="card">
<h3>Categoría</h3>
<input id="catName" placeholder="Nombre">
<input id="catMargin" type="number" placeholder="Ganancia %">
<button onclick="addCategory()">Agregar</button>
</div>

<div class="card">
<h3>Producto</h3>
<input id="prodName" placeholder="Nombre">
<select id="prodCat"></select>
<input id="prodCost" type="number" placeholder="Precio">
<button onclick="saveProduct()">Guardar</button>
</div>

</div>

<div id="listView"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDzDNWaEXQR7UFWrI3r3DhVN628iGwfqfQ",
  authDomain:"despensa-alvi-c7db7.firebaseapp.com",
  projectId:"despensa-alvi-c7db7"
})
const db=firebase.firestore()

let editingProductId=null

function showAdd(){
  addView.style.display="block"
  listView.style.display="none"
  loadCategories()
}

function showList(){
  addView.style.display="none"
  listView.style.display="block"
  renderList()
}

/* CATEGORÍAS */
function loadCategories(){
  prodCat.innerHTML=""
  db.collection("categories").get().then(s=>{
    s.forEach(d=>{
      const c=d.data()
      prodCat.innerHTML+=`<option value="${d.id}">${c.name}</option>`
    })
  })
}

function addCategory(){
  db.collection("categories").add({
    name:catName.value,
    margin:+catMargin.value
  }).then(()=>{catName.value="";catMargin.value="";loadCategories()})
}

/* PRODUCTOS */
function saveProduct(){
  const data={
    name:prodName.value,
    category:prodCat.value,
    price:+prodCost.value
  }

  if(editingProductId){
    db.collection("products").doc(editingProductId).update(data)
  }else{
    db.collection("products").add(data)
  }

  editingProductId=null
  prodName.value=""
  prodCost.value=""
  showList()
}

function renderList(){
  listView.innerHTML=""
  db.collection("products").get().then(s=>{
    s.forEach(d=>{
      const p=d.data()
      listView.innerHTML+=`
      <div class="card">
        <b>${p.name}</b> - $${p.price}
        <button onclick="editProduct('${d.id}')">✏️</button>
      </div>`
    })
  })
}

function editProduct(id){
  db.collection("products").doc(id).get().then(d=>{
    const p=d.data()
    editingProductId=id
    showAdd()
    prodName.value=p.name
    prodCat.value=p.category
    prodCost.value=p.price
  })
}

showList()
</script>

</body>
</html>
